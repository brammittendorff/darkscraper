services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: darkscraper
      POSTGRES_USER: crawler
      POSTGRES_PASSWORD: crawler
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crawler -d darkscraper"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Tor instances (3 always-on, 2 extra via profile) ---
  tor1:
    image: osminogin/tor-simple:latest
    volumes:
      - tor1data:/var/lib/tor
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9050 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tor2:
    image: osminogin/tor-simple:latest
    volumes:
      - tor2data:/var/lib/tor
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9050 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tor3:
    image: osminogin/tor-simple:latest
    volumes:
      - tor3data:/var/lib/tor
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9050 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tor4:
    image: osminogin/tor-simple:latest
    volumes:
      - tor4data:/var/lib/tor
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9050 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tor5:
    image: osminogin/tor-simple:latest
    volumes:
      - tor5data:/var/lib/tor
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9050 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- I2P instances (3 always-on Java I2P, 2 extra via profile) ---
  # Using official Java I2P router for better network connectivity and active network
  i2p1:
    build: ./docker/i2p
    environment:
      JVM_XMX: 768m
      IP_ADDR: 0.0.0.0
    volumes:
      - i2p1data:/i2p/.i2p
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --timeout=10 http://127.0.0.1:7657/ 2>&1 | grep -q '200 OK' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 30
      start_period: 600s

  i2p2:
    build: ./docker/i2p
    environment:
      JVM_XMX: 768m
      IP_ADDR: 0.0.0.0
    volumes:
      - i2p2data:/i2p/.i2p
      - ./docker/i2p/router.config:/i2p/.i2p/router.config
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --timeout=10 http://127.0.0.1:7657/ 2>&1 | grep -q '200 OK' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 30
      start_period: 600s

  i2p3:
    build: ./docker/i2p
    environment:
      JVM_XMX: 768m
      IP_ADDR: 0.0.0.0
    volumes:
      - i2p3data:/i2p/.i2p
      - ./docker/i2p/router.config:/i2p/.i2p/router.config
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --timeout=10 http://127.0.0.1:7657/ 2>&1 | grep -q '200 OK' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 30
      start_period: 600s

  i2p4:
    build: ./docker/i2p
    environment:
      JVM_XMX: 768m
      IP_ADDR: 0.0.0.0
    volumes:
      - i2p4data:/i2p/.i2p
      - ./docker/i2p/router.config:/i2p/.i2p/router.config
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --timeout=10 http://127.0.0.1:7657/ 2>&1 | grep -q '200 OK' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 30
      start_period: 600s

  i2p5:
    build: ./docker/i2p
    environment:
      JVM_XMX: 768m
      IP_ADDR: 0.0.0.0
    volumes:
      - i2p5data:/i2p/.i2p
      - ./docker/i2p/router.config:/i2p/.i2p/router.config
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --timeout=10 http://127.0.0.1:7657/ 2>&1 | grep -q '200 OK' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 30
      start_period: 600s

  # --- ZeroNet instances (3 always-on, 2 extra via profile) ---
  zeronet1:
    build: ./docker/zeronet
    hostname: zeronet1
    volumes:
      - zeronet1data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 43110 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  zeronet2:
    build: ./docker/zeronet
    hostname: zeronet2
    volumes:
      - zeronet2data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 43110 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  zeronet3:
    build: ./docker/zeronet
    hostname: zeronet3
    volumes:
      - zeronet3data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 43110 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  zeronet4:
    build: ./docker/zeronet
    volumes:
      - zeronet4data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 43110 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  zeronet5:
    build: ./docker/zeronet
    volumes:
      - zeronet5data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 43110 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # --- Hyphanet instances (3 always-on, 2 extra via profile) ---
  # FProxy gateway on port 8888, needs allowedhosts for Docker network access
  hyphanet1:
    build: ./docker/hyphanet
    environment:
      allowedhosts: "0.0.0.0/0"
    volumes:
      - hyphanet1data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8888/ 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s

  hyphanet2:
    build: ./docker/hyphanet
    environment:
      allowedhosts: "0.0.0.0/0"
    volumes:
      - hyphanet2data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8888/ 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s

  hyphanet3:
    build: ./docker/hyphanet
    environment:
      allowedhosts: "0.0.0.0/0"
    volumes:
      - hyphanet3data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8888/ 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s

  hyphanet4:
    build: ./docker/hyphanet
    environment:
      allowedhosts: "0.0.0.0/0"
    volumes:
      - hyphanet4data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8888/ 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s

  hyphanet5:
    build: ./docker/hyphanet
    environment:
      allowedhosts: "0.0.0.0/0"
    volumes:
      - hyphanet5data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8888/ 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s

  # --- Lokinet instances (3 always-on, 2 extra via profile) ---
  # SOCKS5 proxy on port 1080 via lokinet-socks image
  # Privileged mode required for TUN interface creation and networking
  lokinet1:
    build: ./docker/lokinet-socks
    privileged: true
    volumes:
      - lokinet1data:/var/lib/lokinet
    healthcheck:
      test: ["CMD-SHELL", "dig +short +timeout=3 @127.3.2.1 exit.loki A 2>/dev/null | grep -q '[0-9]' && nc -z 127.0.0.1 1080 2>/dev/null"]
      interval: 20s
      timeout: 15s
      retries: 30
      start_period: 180s

  lokinet2:
    build: ./docker/lokinet-socks
    privileged: true
    volumes:
      - lokinet2data:/var/lib/lokinet
    healthcheck:
      test: ["CMD-SHELL", "dig +short +timeout=3 @127.3.2.1 exit.loki A 2>/dev/null | grep -q '[0-9]' && nc -z 127.0.0.1 1080 2>/dev/null"]
      interval: 20s
      timeout: 15s
      retries: 30
      start_period: 180s

  lokinet3:
    build: ./docker/lokinet-socks
    privileged: true
    volumes:
      - lokinet3data:/var/lib/lokinet
    healthcheck:
      test: ["CMD-SHELL", "dig +short +timeout=3 @127.3.2.1 exit.loki A 2>/dev/null | grep -q '[0-9]' && nc -z 127.0.0.1 1080 2>/dev/null"]
      interval: 20s
      timeout: 15s
      retries: 30
      start_period: 180s

  lokinet4:
    build: ./docker/lokinet-socks
    privileged: true
    volumes:
      - lokinet4data:/var/lib/lokinet
    healthcheck:
      test: ["CMD-SHELL", "dig +short +timeout=3 @127.3.2.1 exit.loki A 2>/dev/null | grep -q '[0-9]' && nc -z 127.0.0.1 1080 2>/dev/null"]
      interval: 20s
      timeout: 15s
      retries: 30
      start_period: 180s

  lokinet5:
    build: ./docker/lokinet-socks
    privileged: true
    volumes:
      - lokinet5data:/var/lib/lokinet
    healthcheck:
      test: ["CMD-SHELL", "dig +short +timeout=3 @127.3.2.1 exit.loki A 2>/dev/null | grep -q '[0-9]' && nc -z 127.0.0.1 1080 2>/dev/null"]
      interval: 20s
      timeout: 15s
      retries: 30
      start_period: 180s

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: darkscraper
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafanadata:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      postgres:
        condition: service_healthy

  darkscraper:
    build: .
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      tor1:
        condition: service_healthy
      tor2:
        condition: service_healthy
      tor3:
        condition: service_healthy
      i2p1:
        condition: service_started
      i2p2:
        condition: service_started
      i2p3:
        condition: service_started
      hyphanet1:
        condition: service_started
      hyphanet2:
        condition: service_started
      hyphanet3:
        condition: service_started
      lokinet1:
        condition: service_started
      lokinet2:
        condition: service_started
      lokinet3:
        condition: service_started
      zeronet1:
        condition: service_started
      zeronet2:
        condition: service_started
      zeronet3:
        condition: service_started
    volumes:
      - ./config:/etc/darkscraper:ro
      - darkscraperdata:/data
    environment:
      RUST_LOG: info
      # --- Network instance counts (for proxy list generation) ---
      TOR_INSTANCES: ${TOR_INSTANCES:-3}
      I2P_INSTANCES: ${I2P_INSTANCES:-3}
      ZERONET_INSTANCES: ${ZERONET_INSTANCES:-3}
      HYPHANET_INSTANCES: ${HYPHANET_INSTANCES:-3}
      LOKINET_INSTANCES: ${LOKINET_INSTANCES:-3}
      # --- Network worker tuning (override via docker compose up) ---
      TOR_WORKERS: ${TOR_WORKERS:-32}
      TOR_ENABLED: ${TOR_ENABLED:-true}
      I2P_WORKERS: ${I2P_WORKERS:-8}
      I2P_ENABLED: ${I2P_ENABLED:-true}
      ZERONET_WORKERS: ${ZERONET_WORKERS:-8}
      ZERONET_ENABLED: ${ZERONET_ENABLED:-true}
      HYPHANET_WORKERS: ${HYPHANET_WORKERS:-8}
      HYPHANET_ENABLED: ${HYPHANET_ENABLED:-true}
      LOKINET_WORKERS: ${LOKINET_WORKERS:-8}
      LOKINET_ENABLED: ${LOKINET_ENABLED:-true}
      MAX_DEPTH: ${MAX_DEPTH:-10}
    entrypoint: ["darkscraper", "--config", "/etc/darkscraper/default.toml"]
    command: ["crawl"]

volumes:
  pgdata:
  tor1data:
  tor2data:
  tor3data:
  tor4data:
  tor5data:
  i2p1data:
  i2p2data:
  i2p3data:
  i2p4data:
  i2p5data:
  zeronet1data:
  zeronet2data:
  zeronet3data:
  zeronet4data:
  zeronet5data:
  hyphanet1data:
  hyphanet2data:
  hyphanet3data:
  hyphanet4data:
  hyphanet5data:
  lokinet1data:
  lokinet2data:
  lokinet3data:
  lokinet4data:
  lokinet5data:
  darkscraperdata:
  grafanadata:
